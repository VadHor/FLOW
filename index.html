<!DOCTYPE html>
<html lang="fr" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProjectFlow ULTRA</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        primary: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' },
                        dark: { bg: '#0f172a', surface: '#1e293b', border: '#334155', text: '#f8fafc', textMuted: '#94a3b8' }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        [x-cloak] { display: none !important; }
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter, .fade-leave-to { opacity: 0; }
        
        .scale-enter-active { transition: all 0.2s ease-out; }
        .scale-enter-start { opacity: 0; transform: scale(0.95); }
        .scale-enter-end { opacity: 1; transform: scale(1); }

        /* Ghost drag */
        .ghost {
            opacity: 0.5;
            background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e1 100%);
            border: 2px dashed #3b82f6;
            transform: scale(0.98) rotate(2deg);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
            cursor: grabbing !important;
        }
        .dark .ghost {
            background: linear-gradient(135deg, #334155 0%, #1e293b 100%);
            border-color: #3b82f6;
        }

        /* Drag handle cursor */
        .sortable-handle { cursor: grab; }
        .sortable-handle:active { cursor: grabbing; }

        /* Drag feedback */
        .sortable-drag {
            opacity: 0.8;
            transform: scale(1.05);
            box-shadow: 0 20px 40px -10px rgba(59, 130, 246, 0.4);
            z-index: 9999;
        }

        /* Drop zone highlight */
        .sortable-chosen {
            background: rgba(59, 130, 246, 0.05);
            border-color: #3b82f6;
        }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300 h-screen flex overflow-hidden" 
      x-data="app()" x-init="initApp()">

    <div class="fixed top-5 right-5 z-[60] flex flex-col gap-2 pointer-events-none">
        <template x-for="toast in toasts" :key="toast.id">
            <div class="pointer-events-auto bg-white dark:bg-dark-surface border-l-4 shadow-lg rounded-r px-4 py-3 flex items-center gap-3 transform transition-all duration-300"
                 :class="{
                    'border-green-500': toast.type === 'success',
                    'border-red-500': toast.type === 'error',
                    'border-blue-500': toast.type === 'info'
                 }"
                 x-transition:enter="translate-x-full opacity-0"
                 x-transition:enter-end="translate-x-0 opacity-100"
                 x-transition:leave="translate-x-full opacity-0">
                <i :class="{
                    'fa-circle-check text-green-500': toast.type === 'success',
                    'fa-circle-exclamation text-red-500': toast.type === 'error',
                    'fa-circle-info text-blue-500': toast.type === 'info'
                }" class="fa-solid text-lg"></i>
                <div>
                    <h4 class="font-bold text-sm dark:text-white" x-text="toast.title"></h4>
                    <p class="text-xs text-gray-500 dark:text-dark-textMuted" x-text="toast.message"></p>
                </div>
            </div>
        </template>
    </div>

    <aside class="w-72 bg-white dark:bg-dark-surface border-r border-gray-200 dark:border-dark-border flex flex-col z-20 transition-colors duration-300">
        <div class="h-16 flex items-center px-8 border-b border-gray-100 dark:border-dark-border gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-primary-500 to-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-primary-500/30">
                <i class="fa-solid fa-bolt"></i>
            </div>
            <span class="font-bold text-lg tracking-tight">ProjectFlow</span>
        </div>

        <nav class="flex-1 p-6 space-y-2 overflow-y-auto">
            <template x-for="item in menuItems">
                <button @click="currentView = item.id"
                    :class="currentView === item.id
                        ? 'bg-primary-50 text-primary-700 dark:bg-primary-900/20 dark:text-primary-400 font-semibold'
                        : 'text-gray-500 dark:text-dark-textMuted hover:bg-gray-50 dark:hover:bg-gray-800/50'"
                    class="w-full text-left px-5 py-3 rounded-lg flex items-center gap-3 transition-all duration-200 group">
                    <i :class="item.icon" class="w-5 text-center transition-transform group-hover:scale-110"></i>
                    <span x-text="item.label"></span>
                </button>
            </template>
        </nav>

        <div class="p-4 border-t border-gray-100 dark:border-dark-border space-y-3">
            <button @click="toggleTheme()" class="w-full flex items-center justify-between px-3 py-2 text-xs font-medium text-gray-500 dark:text-dark-textMuted bg-gray-100 dark:bg-gray-800 rounded-md hover:text-gray-800 dark:hover:text-white transition">
                <span x-text="isDark ? 'Mode Sombre' : 'Mode Clair'"></span>
                <i :class="isDark ? 'fa-moon text-indigo-400' : 'fa-sun text-amber-500'" class="fa-solid"></i>
            </button>
            
            <div class="grid grid-cols-2 gap-2">
                <button @click="exportData" class="py-1.5 px-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded text-xs hover:bg-gray-50 dark:hover:bg-gray-600 transition text-gray-600 dark:text-gray-300">
                    <i class="fa-solid fa-download mr-1"></i> Backup (JSON)
                </button>
                <label class="py-1.5 px-2 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded text-xs hover:bg-gray-50 dark:hover:bg-gray-600 transition text-center cursor-pointer text-gray-600 dark:text-gray-300">
                    <i class="fa-solid fa-upload mr-1"></i> Restore (JSON)
                    <input type="file" class="hidden" @change="importData">
                </label>
            </div>
        </div>
    </aside>

    <main class="flex-1 flex flex-col min-w-0 bg-gray-50 dark:bg-dark-bg transition-colors duration-300 relative">
        
        <header class="h-20 bg-white/80 dark:bg-dark-surface/80 backdrop-blur-md border-b border-gray-200 dark:border-dark-border px-8 flex justify-between items-center z-10 sticky top-0">
            <div class="flex items-center gap-4">
                <h2 class="text-xl font-bold text-gray-800 dark:text-white" x-text="menuItems.find(i => i.id === currentView).label"></h2>
                
                <div class="relative group">
                    <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 group-focus-within:text-primary-500 transition-colors"></i>
                    <input type="text" x-model="searchQuery" placeholder="Rechercher..." 
                        class="pl-9 pr-4 py-1.5 bg-gray-100 dark:bg-gray-800 border-none rounded-full text-sm w-48 focus:w-64 transition-all focus:ring-2 focus:ring-primary-500/50 dark:text-white placeholder-gray-400 outline-none">
                </div>
            </div>
            
            <div class="flex gap-3">
                <button x-show="currentView !== 'dashboard'" @click="openModalForView()" 
                    class="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg shadow-lg shadow-primary-500/30 transition-all active:scale-95 flex items-center gap-2 font-medium text-sm">
                    <i class="fa-solid fa-plus"></i> <span x-text="getAddButtonLabel()"></span>
                </button>
                <button x-show="currentView === 'dashboard'" @click="exportExcel" 
                    class="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded-lg shadow-lg shadow-emerald-500/30 transition-all flex items-center gap-2 font-medium text-sm">
                    <i class="fa-solid fa-file-excel"></i> Rapport Excel
                </button>
            </div>
        </header>

        <div class="flex-1 overflow-auto p-8 scroll-smooth">

            <div x-show="currentView === 'dashboard'" x-transition:enter="fade-enter-active" x-transition:enter-start="fade-enter" x-cloak class="space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border flex items-center justify-between relative overflow-hidden group">
                        <div class="absolute right-0 top-0 p-24 bg-primary-500/5 rounded-full blur-3xl -mr-10 -mt-10"></div>
                        <div>
                            <div class="text-gray-500 dark:text-dark-textMuted text-sm font-medium mb-1">Taux de succès</div>
                            <div class="text-3xl font-bold dark:text-white" x-text="calculateGlobalProgress() + '%'"></div>
                            <div class="text-xs text-green-500 mt-1 flex items-center"><i class="fa-solid fa-arrow-trend-up mr-1"></i> Global</div>
                        </div>
                        <div class="relative w-16 h-16">
                            <svg class="w-full h-full transform -rotate-90">
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" class="text-gray-200 dark:text-gray-700" />
                                <circle cx="32" cy="32" r="28" stroke="currentColor" stroke-width="6" fill="transparent" :stroke-dasharray="175.9" :stroke-dashoffset="175.9 - (calculateGlobalProgress() / 100 * 175.9)" class="text-primary-500 transition-all duration-1000 ease-out" />
                            </svg>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border group hover:border-primary-200 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-gray-500 dark:text-dark-textMuted text-sm font-medium">Tâches en cours</div>
                                <div class="text-3xl font-bold dark:text-white mt-1" x-text="tasks.filter(t=>t.status === 'En cours').length"></div>
                            </div>
                            <div class="p-2 bg-blue-50 dark:bg-blue-900/30 rounded-lg text-blue-600 dark:text-blue-400"><i class="fa-solid fa-spinner"></i></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border group hover:border-red-200 transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-gray-500 dark:text-dark-textMuted text-sm font-medium">Urgences absolues</div>
                                <div class="text-3xl font-bold text-red-600 mt-1" x-text="tasks.filter(t => t.urgent && t.important && t.status !== 'Terminé').length"></div>
                            </div>
                            <div class="p-2 bg-red-50 dark:bg-red-900/30 rounded-lg text-red-600 dark:text-red-400"><i class="fa-solid fa-fire"></i></div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border group hover:border-purple-200 transition">
                         <div class="flex justify-between items-start">
                            <div>
                                <div class="text-gray-500 dark:text-dark-textMuted text-sm font-medium">Contacts</div>
                                <div class="text-3xl font-bold dark:text-white mt-1" x-text="contacts.length"></div>
                            </div>
                            <div class="p-2 bg-purple-50 dark:bg-purple-900/30 rounded-lg text-purple-600 dark:text-purple-400"><i class="fa-solid fa-users"></i></div>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border overflow-hidden">
                    <div class="px-8 py-5 border-b border-gray-100 dark:border-dark-border flex justify-between items-center">
                        <h3 class="font-bold text-gray-800 dark:text-white text-lg">État du Portefeuille</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-800/50 text-xs uppercase font-semibold text-gray-500 dark:text-gray-400">
                                <tr>
                                    <th class="px-8 py-5">Projet</th>
                                    <th class="px-8 py-5">Status</th>
                                    <th class="px-8 py-5 w-1/3">Progression</th>
                                    <th class="px-8 py-5 text-center">Reste</th>
                                    <th class="px-8 py-5 text-right">Action</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100 dark:divide-dark-border">
                                <template x-for="p in filteredProjects" :key="p.id">
                                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-800/50 transition group">
                                        <td class="px-8 py-5">
                                            <div class="flex items-center gap-3">
                                                <div class="w-2 h-10 rounded-full" :style="'background-color:'+p.color"></div>
                                                <div>
                                                    <div class="font-bold text-gray-800 dark:text-white" x-text="p.name"></div>
                                                    <div class="text-xs text-gray-500" x-text="p.role"></div>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="px-8 py-5">
                                            <span class="px-2.5 py-1 rounded-full text-xs font-medium border" 
                                                :class="{
                                                    'bg-green-50 text-green-700 border-green-200 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800': p.status==='Actif',
                                                    'bg-gray-100 text-gray-700 border-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-700': p.status==='Clôturé',
                                                    'bg-amber-50 text-amber-700 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400 dark:border-amber-800': p.status==='Pause',
                                                    'bg-blue-50 text-blue-700 border-blue-200 dark:bg-blue-900/30 dark:text-blue-400 dark:border-blue-800': p.status==='Préparation'
                                                }" x-text="p.status"></span>
                                        </td>
                                        <td class="px-8 py-5">
                                            <div class="flex items-center gap-3">
                                                <div class="flex-1 bg-gray-100 dark:bg-gray-700 rounded-full h-2 overflow-hidden">
                                                    <div class="h-full rounded-full transition-all duration-1000" :style="'width: '+getProjectProgress(p.id)+'%; background-color:'+p.color"></div>
                                                </div>
                                                <span class="text-xs font-bold w-8 text-right dark:text-gray-300" x-text="getProjectProgress(p.id)+'%'"></span>
                                            </div>
                                        </td>
                                        <td class="px-8 py-5 text-center text-gray-500 dark:text-gray-400 text-xs">
                                            <span x-text="getRemainingDays(p.endDate)"></span>j
                                        </td>
                                        <td class="px-8 py-5 text-right">
                                            <button @click="openProjectModal(p)" class="text-gray-400 hover:text-primary-500 dark:hover:text-primary-400 transition"><i class="fa-solid fa-pen"></i></button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div x-show="currentView === 'roadmap'" x-transition:enter="fade-enter-active" x-cloak class="space-y-8">
                <div class="bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border p-8 overflow-x-auto">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                            <i class="fa-solid fa-route"></i>
                        </div>
                        <h3 class="font-bold text-gray-800 dark:text-white text-lg">Timeline des Projets</h3>
                    </div>

                    <!-- Sélecteur de projets -->
                    <div class="mb-6 flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                        <button @click="filterRoadmapProject = null"
                            class="px-4 py-2 rounded-full text-sm font-medium transition shadow-sm border"
                            :class="!filterRoadmapProject ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-dark-surface dark:text-gray-300 dark:border-gray-600'">
                            <i class="fa-solid fa-layer-group mr-2"></i>Tous les projets
                        </button>
                        <template x-for="p in projects.filter(p => p.status !== 'Clôturé')" :key="p.id">
                            <button @click="filterRoadmapProject = p.id"
                                class="px-4 py-2 rounded-full text-sm font-medium transition shadow-sm border flex items-center gap-2 whitespace-nowrap"
                                :class="filterRoadmapProject === p.id ? 'text-white border-transparent' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-dark-surface dark:text-gray-300 dark:border-gray-600'"
                                :style="filterRoadmapProject === p.id ? 'background-color:'+p.color : ''">
                                <span class="w-2 h-2 rounded-full bg-white/50" x-show="filterRoadmapProject !== p.id" :style="'background-color:'+p.color"></span>
                                <span x-text="p.name"></span>
                            </button>
                        </template>
                    </div>

                    <div class="min-w-[800px] space-y-8">
                        <template x-for="p in filteredProjects.filter(p => p.status !== 'Clôturé' && (!filterRoadmapProject || p.id === filterRoadmapProject))" :key="p.id">
                            <div>
                                <div class="flex items-center gap-2 mb-3">
                                    <span class="w-3 h-3 rounded-full" :style="'background-color:'+p.color"></span>
                                    <h4 class="font-bold text-sm dark:text-white" x-text="p.name"></h4>
                                </div>
                                <div class="relative bg-gray-50 dark:bg-gray-800 h-24 rounded-lg border border-gray-100 dark:border-gray-700 w-full overflow-hidden flex items-center px-4">
                                    <div class="absolute inset-0 grid grid-cols-12 divide-x divide-gray-200 dark:divide-gray-700 opacity-20 pointer-events-none">
                                        <div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div>
                                    </div>

                                    <template x-for="t in tasks.filter(x => x.projectId === p.id && x.status !== 'Terminé' && x.dueDate)" :key="t.id">
                                        <div class="absolute h-8 rounded px-3 text-xs flex items-center text-white shadow-md cursor-pointer hover:brightness-110 hover:z-10 transition tooltip-trigger"
                                             :style="getGanttStyle(t, p.color)"
                                             @click="openTaskModal(t)"
                                             :title="t.title + ' (échéance: ' + formatDate(t.dueDate) + ')'">
                                            <span class="truncate font-medium" x-text="t.title"></span>
                                            <span class="absolute -top-1 -right-1 w-2 h-2 rounded-full bg-red-500 border border-white" x-show="t.urgent"></span>
                                        </div>
                                    </template>
                                    
                                    <div x-show="tasks.filter(x => x.projectId === p.id && x.dueDate).length === 0" class="w-full text-center text-xs text-gray-400 italic">
                                        Aucune tâche planifiée avec date
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <div x-show="currentView === 'kanban'" x-transition:enter="fade-enter-active" x-cloak class="h-full flex flex-col">
                <div class="mb-4 flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    <button @click="filterProject = null" 
                        class="px-4 py-1.5 rounded-full text-sm font-medium transition shadow-sm border"
                        :class="!filterProject ? 'bg-gray-800 text-white border-gray-800 dark:bg-white dark:text-gray-900' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-dark-surface dark:text-gray-300 dark:border-gray-600'">
                        Tous
                    </button>
                    <template x-for="p in projects" :key="p.id">
                        <button @click="filterProject = p.id" 
                            class="px-4 py-1.5 rounded-full text-sm font-medium transition shadow-sm border flex items-center gap-2 whitespace-nowrap"
                            :class="filterProject === p.id ? 'text-white border-transparent' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50 dark:bg-dark-surface dark:text-gray-300 dark:border-gray-600'"
                            :style="filterProject === p.id ? 'background-color:'+p.color : ''">
                            <span class="w-2 h-2 rounded-full bg-white/50" x-show="filterProject !== p.id" :style="'background-color:'+p.color"></span>
                            <span x-text="p.name"></span>
                        </button>
                    </template>
                </div>

                <div class="flex-1 flex gap-8 overflow-x-auto pb-4 h-full items-start">
                    <template x-for="status in kanbanColumns" :key="status">
                        <div class="min-w-[380px] w-[380px] flex flex-col bg-gray-100 dark:bg-gray-800/50 rounded-xl border border-gray-200 dark:border-dark-border max-h-full">
                            <div class="p-4 font-bold text-gray-700 dark:text-gray-200 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center bg-gray-50 dark:bg-gray-800 rounded-t-xl sticky top-0 z-10">
                                <div class="flex items-center gap-2">
                                    <span class="w-2 h-2 rounded-full" :class="{
                                        'bg-gray-400': status=='À faire', 'bg-blue-400': status=='En cours', 'bg-amber-400': status=='En attente', 'bg-green-400': status=='Terminé'
                                    }"></span>
                                    <span x-text="status"></span>
                                </div>
                                <span class="bg-white dark:bg-gray-700 text-gray-600 dark:text-gray-300 text-xs px-2 py-0.5 rounded-full shadow-sm border border-gray-100 dark:border-gray-600 font-mono" x-text="getTasksByStatus(status).length"></span>
                            </div>
                            
                            <div class="flex-1 p-4 overflow-y-auto space-y-4 sortable-kanban" :data-status="status" x-init="initSortable($el)">
                                <template x-for="task in getTasksByStatus(status)" :key="task.id">
                                    <div class="bg-white dark:bg-dark-surface p-5 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700 cursor-grab hover:shadow-md hover:border-primary-300 dark:hover:border-primary-700 transition group relative" :data-id="task.id">
                                        <div class="absolute -left-1 top-1/2 -translate-y-1/2 opacity-0 group-hover:opacity-40 transition-opacity text-gray-400 text-sm pointer-events-none">
                                            <i class="fa-solid fa-grip-vertical"></i>
                                        </div>
                                        <div class="flex flex-wrap gap-1.5 mb-2">
                                            <span x-show="task.urgent" class="bg-red-50 text-red-600 dark:bg-red-900/30 dark:text-red-400 text-[10px] px-1.5 py-0.5 rounded font-bold uppercase tracking-wider border border-red-100 dark:border-transparent">Urgent</span>
                                            <span x-show="task.projectId" class="bg-gray-50 text-gray-600 dark:bg-gray-700 dark:text-gray-300 text-[10px] px-1.5 py-0.5 rounded border border-gray-100 dark:border-gray-600 truncate max-w-[120px]" x-text="getProjectName(task.projectId)"></span>
                                        </div>
                                        
                                        <div class="font-semibold text-gray-800 dark:text-gray-100 text-sm mb-2 leading-snug" x-text="task.title"></div>
                                        
                                        <div x-show="Object.keys(task.customFields || {}).length > 0" class="flex gap-2 text-xs text-gray-400 dark:text-gray-500 mb-2">
                                            <template x-for="(value, key, index) in task.customFields" :key="key">
                                                <span x-show="index < 2" class="truncate max-w-[100px]"><strong x-text="key+':'"></strong> <span x-text="value"></span></span>
                                            </template>
                                        </div>

                                        <div class="flex justify-between items-center mt-3 pt-3 border-t border-gray-50 dark:border-gray-700/50">
                                            <div class="flex -space-x-2">
                                                <template x-for="cid in (task.participants || []).slice(0,3)">
                                                     <div class="w-6 h-6 rounded-full bg-primary-100 dark:bg-primary-900 border-2 border-white dark:border-dark-surface text-[9px] flex items-center justify-center text-primary-700 dark:text-primary-300 font-bold uppercase" :title="getContactName(cid)" x-text="getContactInitials(cid)"></div>
                                                </template>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="text-xs text-gray-400" x-show="task.dueDate" :class="isOverdue(task.dueDate) ? 'text-red-500 font-bold' : ''">
                                                    <i class="fa-regular fa-clock mr-1"></i><span x-text="formatDateShort(task.dueDate)"></span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity flex bg-white dark:bg-dark-surface shadow-sm rounded-md border border-gray-100 dark:border-gray-600 p-0.5">
                                            <button @click.stop="openTaskModal(task)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-primary-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded" title="Éditer"><i class="fa-solid fa-pencil text-xs"></i></button>
                                            <button @click.stop="openMeetingModal(task)" class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-purple-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded" title="Planifier réunion"><i class="fa-solid fa-calendar-plus text-xs"></i></button>
                                            <button x-show="task.participants && task.participants.length > 0"
                                                    @click.stop="emailTaskAssignmentICS(task)"
                                                    class="w-7 h-7 flex items-center justify-center text-gray-500 hover:text-blue-600 hover:bg-gray-50 dark:hover:bg-gray-700 rounded"
                                                    title="Envoyer attribution par email">
                                                <i class="fa-solid fa-paper-plane text-xs"></i>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                            </div>
                             <div class="p-2">
                                <button @click="openTaskModal({status: status})" class="w-full py-2 border-2 border-dashed border-gray-200 dark:border-gray-600 rounded-lg text-gray-400 dark:text-gray-500 text-sm font-medium hover:border-primary-400 hover:text-primary-500 dark:hover:text-primary-400 transition flex items-center justify-center gap-2">
                                    <i class="fa-solid fa-plus"></i> Ajouter
                                </button>
                             </div>
                        </div>
                    </template>
                </div>
            </div>

            <div x-show="currentView === 'eisenhower'" x-cloak class="h-full grid grid-cols-2 grid-rows-2 gap-4 p-2">
                <template x-for="q in eisenhowerQuadrants">
                    <div :class="q.bgClass" class="rounded-2xl border flex flex-col overflow-hidden shadow-sm relative transition-colors duration-300">
                        <div :class="q.headerClass" class="px-5 py-3 font-bold flex justify-between items-center text-sm uppercase tracking-wide">
                            <span x-html="q.icon + ' ' + q.title"></span>
                            <span class="bg-white/50 px-2 py-0.5 rounded text-xs" x-text="getMatrixTasks(q.u, q.i).length"></span>
                        </div>
                        <div class="p-4 flex-1 overflow-y-auto space-y-2 sortable-matrix" :data-u="q.u" :data-i="q.i" x-init="initMatrixSortable($el)">
                             <template x-for="t in getMatrixTasks(q.u, q.i)" :key="t.id">
                                 <div class="bg-white dark:bg-dark-surface p-3 rounded-lg shadow-sm border-l-4 cursor-grab hover:shadow-md transition text-sm flex justify-between items-start group" 
                                      :class="q.borderClass" :data-id="t.id">
                                     <div>
                                         <div class="font-medium dark:text-gray-200" x-text="t.title"></div>
                                         <div class="text-xs text-gray-400 mt-1" x-text="getProjectName(t.projectId)"></div>
                                     </div>
                                     <button @click.stop="openTaskModal(t)" class="text-gray-300 hover:text-gray-600 opacity-0 group-hover:opacity-100"><i class="fa-solid fa-pen"></i></button>
                                 </div>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
            
            <div x-show="currentView === 'contacts'" x-cloak class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 sortable-contacts" x-init="initContactsSortable($el)">
                 <template x-for="c in filteredContacts" :key="c.id">
                     <div :data-id="c.id" class="bg-white dark:bg-dark-surface p-8 rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border flex items-center gap-4 group hover:border-primary-200 transition cursor-grab relative">
                        <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-30 transition-opacity text-gray-400 text-xs pointer-events-none">
                            <i class="fa-solid fa-grip-vertical"></i>
                        </div>
                        <div class="w-12 h-12 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-700 dark:to-gray-800 flex items-center justify-center text-lg font-bold text-gray-600 dark:text-gray-300 shadow-inner">
                            <span x-text="getContactInitials(c.id)"></span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 dark:text-white truncate" x-text="c.name"></h4>
                            <p class="text-xs text-primary-600 dark:text-primary-400 truncate" x-text="c.org || 'Indépendant'"></p>
                            <div class="flex gap-2 mt-2 text-xs text-gray-500 dark:text-gray-400">
                                <a :href="'mailto:'+c.email" class="hover:text-primary-500 transition"><i class="fa-solid fa-envelope"></i></a>
                                <span x-show="c.phone">•</span>
                                <span x-text="c.phone"></span>
                            </div>
                        </div>
                        <button @click="openContactModal(c)" class="opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-primary-500 transition"><i class="fa-solid fa-pencil"></i></button>
                     </div>
                 </template>
                 <button @click="openContactModal()" class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:border-primary-400 hover:text-primary-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition p-6 min-h-[120px]">
                     <i class="fa-solid fa-plus text-2xl mb-2"></i>
                     <span class="font-medium text-sm">Ajouter Contact</span>
                 </button>
            </div>
            
             <div x-show="currentView === 'projects'" x-cloak class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 sortable-projects" x-init="initProjectsSortable($el)">
                <template x-for="p in filteredProjects" :key="p.id">
                     <div :data-id="p.id" class="bg-white dark:bg-dark-surface rounded-2xl shadow-sm border border-gray-100 dark:border-dark-border p-8 flex flex-col relative group hover:shadow-lg transition-all duration-300 cursor-grab">
                        <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-30 transition-opacity text-gray-400 text-xs pointer-events-none">
                            <i class="fa-solid fa-grip-vertical"></i>
                        </div>
                        <div class="flex justify-between items-start mb-4">
                            <div class="w-12 h-12 rounded-xl flex items-center justify-center text-white font-bold text-lg shadow-lg shadow-gray-200 dark:shadow-none" :style="'background-color:' + p.color">
                                <span x-text="p.name.substring(0,2).toUpperCase()"></span>
                            </div>
                            <div class="flex gap-1">
                                <button @click="openProjectModal(p)" class="w-8 h-8 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-primary-500 transition flex items-center justify-center"><i class="fa-solid fa-pen text-xs"></i></button>
                                <button @click="deleteProject(p.id)" class="w-8 h-8 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 text-gray-400 hover:text-red-500 transition flex items-center justify-center"><i class="fa-solid fa-trash text-xs"></i></button>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg text-gray-800 dark:text-white mb-1" x-text="p.name"></h3>
                        <div class="flex items-center gap-2 text-xs mb-4">
                            <span class="px-2 py-0.5 rounded bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 border border-gray-200 dark:border-gray-600" x-text="p.role"></span>
                            <span class="text-gray-400" x-show="p.endDate">Fin: <span x-text="formatDateShort(p.endDate)"></span></span>
                        </div>
                        <p class="text-sm text-gray-500 dark:text-gray-400 mb-6 flex-1 line-clamp-3" x-text="p.description || 'Aucune description'"></p>
                        
                        <div>
                            <div class="flex justify-between text-xs mb-1 font-medium text-gray-600 dark:text-gray-400">
                                <span>Progression</span>
                                <span x-text="getProjectProgress(p.id)+'%'"></span>
                            </div>
                            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5 overflow-hidden">
                                <div class="h-full rounded-full transition-all duration-1000" :style="'width: ' + getProjectProgress(p.id) + '%; background-color:' + p.color"></div>
                            </div>
                        </div>
                     </div>
                </template>
                 <button @click="openProjectModal()" class="border-2 border-dashed border-gray-200 dark:border-gray-700 rounded-2xl flex flex-col items-center justify-center text-gray-400 hover:border-primary-400 hover:text-primary-500 hover:bg-gray-50 dark:hover:bg-gray-800 transition min-h-[250px]">
                     <div class="w-12 h-12 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center mb-3">
                         <i class="fa-solid fa-plus text-xl"></i>
                     </div>
                     <span class="font-bold">Créer un projet</span>
                 </button>
            </div>

        </div>
    </main>

    <div x-show="modals.project || modals.task || modals.contact || modals.meeting" 
         x-transition.opacity 
         class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900/60 backdrop-blur-sm p-4" x-cloak>
        
        <div x-show="modals.project" @click.away="modals.project = false" x-transition:enter="scale-enter-active" x-transition:enter-start="scale-enter-start" class="bg-white dark:bg-dark-surface w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-5 border-b border-gray-100 dark:border-gray-700 font-bold text-xl dark:text-white">Projet</div>
            <div class="p-8 space-y-5 overflow-y-auto">
                <input type="text" x-model="tempProject.name" placeholder="Nom du projet" class="w-full text-lg font-bold border-b-2 border-gray-200 dark:border-gray-700 pb-2 focus:border-primary-500 bg-transparent dark:text-white outline-none transition-colors">
                <textarea x-model="tempProject.description" placeholder="Description courte..." rows="3" class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-lg p-3 text-sm focus:ring-2 focus:ring-primary-500/50 dark:text-gray-200 resize-none"></textarea>
                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="label-xs">Rôle</label>
                        <select x-model="tempProject.role" class="input-std"><option>Leader</option><option>Contributeur</option></select>
                    </div>
                    <div>
                        <label class="label-xs">Statut</label>
                        <select x-model="tempProject.status" class="input-std"><option>Préparation</option><option>Actif</option><option>Pause</option><option>Clôturé</option></select>
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="label-xs">Date Fin</label>
                        <input type="date" x-model="tempProject.endDate" class="input-std">
                    </div>
                    <div>
                        <label class="label-xs">Couleur</label>
                        <div class="flex gap-2 mt-1">
                            <template x-for="c in ['#3b82f6','#ef4444','#10b981','#f59e0b','#8b5cf6','#ec4899']">
                                <button @click="tempProject.color = c" class="w-6 h-6 rounded-full border-2 transition transform hover:scale-110" :class="tempProject.color === c ? 'border-gray-600 dark:border-white' : 'border-transparent'" :style="'background-color:'+c"></button>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button @click="modals.project = false" class="btn-secondary">Annuler</button>
                <button @click="saveProject()" class="btn-primary">Enregistrer</button>
            </div>
        </div>

        <div x-show="modals.task" @click.away="modals.task = false" x-transition:enter="scale-enter-active" x-transition:enter-start="scale-enter-start" class="bg-white dark:bg-dark-surface w-full max-w-6xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-8 py-5 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-bold uppercase text-gray-400 tracking-wider">Tâche</span>
                    <button x-show="tempTask.id" @click="deleteTask(tempTask.id)" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 p-1 rounded transition"><i class="fa-solid fa-trash-can"></i></button>
                </div>
                <div class="flex gap-2">
                    <button @click="tempTask.urgent = !tempTask.urgent" class="px-3 py-1 rounded-full text-xs font-bold border transition" :class="tempTask.urgent ? 'bg-red-50 text-red-600 border-red-200 dark:bg-red-900/30 dark:text-red-400' : 'text-gray-400 border-gray-200 dark:border-gray-700'">URGENT</button>
                    <button @click="tempTask.important = !tempTask.important" class="px-3 py-1 rounded-full text-xs font-bold border transition" :class="tempTask.important ? 'bg-amber-50 text-amber-600 border-amber-200 dark:bg-amber-900/30 dark:text-amber-400' : 'text-gray-400 border-gray-200 dark:border-gray-700'">IMPORTANT</button>
                </div>
            </div>
            <div class="flex-1 overflow-y-auto p-8 grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-2 space-y-6">
                    <input type="text" x-model="tempTask.title" placeholder="Titre de la tâche..." class="w-full text-xl font-bold bg-transparent border-none p-0 focus:ring-0 dark:text-white placeholder-gray-300">
                    <textarea x-model="tempTask.description" placeholder="Ajouter une description..." rows="4" class="w-full bg-gray-50 dark:bg-gray-800 border-none rounded-lg p-4 text-sm focus:ring-2 focus:ring-primary-500/50 dark:text-gray-200 resize-none"></textarea>
                    
                    <div>
                        <label class="label-xs mb-2 block">Notes de Réunion</label>
                        <textarea x-model="tempTask.notes" placeholder="Ajoutez des notes pendant la réunion..." rows="3" class="w-full bg-white dark:bg-dark-surface input-std p-3 text-sm focus:ring-2 focus:ring-primary-500/50 dark:text-gray-200 resize-none"></textarea>
                        <div class="mt-2 flex gap-2">
                            <button @click="copyNotes(tempTask.notes)" type="button" class="btn-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-1 rounded-md text-xs border border-gray-200 dark:border-gray-600 transition"><i class="fa-solid fa-copy mr-1"></i> Copier</button>
                            <button @click="emailNotes(tempTask.notes, tempTask.title)" type="button" class="btn-sm text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 px-3 py-1 rounded-md text-xs border border-gray-200 dark:border-gray-600 transition"><i class="fa-solid fa-envelope mr-1"></i> Envoyer par e-mail</button>
                        </div>
                    </div>
                    
                    <div>
                         <label class="label-xs mb-2 block">Checklist</label>
                         <div class="space-y-2">
                             <template x-for="(item, index) in tempTask.checklist" :key="index">
                                 <div class="flex items-center gap-2 p-2 bg-white dark:bg-dark-surface rounded-lg border border-gray-200 dark:border-gray-600 hover:border-primary-300 dark:hover:border-primary-600 transition">
                                     <input type="checkbox"
                                            x-model="item.completed"
                                            class="w-5 h-5 text-primary-600 border-gray-300 rounded focus:ring-primary-500 cursor-pointer">
                                     <input type="text"
                                            x-model="item.text"
                                            placeholder="Élément de checklist..."
                                            class="flex-1 bg-transparent border-none p-0 text-sm focus:ring-0 dark:text-white"
                                            :class="item.completed ? 'line-through text-gray-400' : ''">
                                     <button @click="tempTask.checklist.splice(index, 1)"
                                             type="button"
                                             class="text-red-500 hover:text-red-700 transition px-2">
                                         <i class="fa-solid fa-trash text-xs"></i>
                                     </button>
                                 </div>
                             </template>
                             <button @click="tempTask.checklist.push({ text: '', completed: false })"
                                     type="button"
                                     class="w-full py-2 text-primary-600 hover:text-primary-700 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition text-sm font-medium flex items-center justify-center gap-2 rounded-lg border-2 border-dashed border-gray-300 dark:border-gray-600">
                                 <i class="fa-solid fa-plus"></i> Ajouter un élément
                             </button>
                             <div x-show="tempTask.checklist && tempTask.checklist.length > 0" class="text-xs text-gray-500 dark:text-gray-400 pt-2">
                                 <span x-text="tempTask.checklist.filter(i => i.completed).length"></span> / <span x-text="tempTask.checklist.length"></span> éléments complétés
                             </div>
                         </div>
                    </div>
                </div>
                
                <div class="space-y-4 bg-gray-50 dark:bg-gray-800/50 p-4 rounded-xl h-fit">
                    <div>
                        <label class="label-xs">Projet</label>
                        <select x-model="tempTask.projectId" class="input-std bg-white dark:bg-dark-surface">
                            <option value="">-- Aucun --</option>
                            <template x-for="p in projects" :key="p.id"><option :value="p.id" x-text="p.name"></option></template>
                        </select>
                    </div>
                    <div>
                        <label class="label-xs">Statut</label>
                        <select x-model="tempTask.status" class="input-std bg-white dark:bg-dark-surface">
                            <template x-for="s in kanbanColumns"><option :value="s" x-text="s"></option></template>
                        </select>
                    </div>
                    <div>
                        <label class="label-xs">Échéance</label>
                        <input type="date" x-model="tempTask.dueDate" class="input-std bg-white dark:bg-dark-surface">
                    </div>
                    <div>
                        <label class="label-xs">Participants</label>
                        <div class="flex flex-wrap gap-1 mt-1">
                             <template x-for="c in contacts">
                                 <button @click="toggleParticipant(c.id)" 
                                    class="w-8 h-8 rounded-full border-2 flex items-center justify-center text-xs font-bold transition"
                                    :class="tempTask.participants.includes(c.id) ? 'bg-primary-600 border-primary-600 text-white' : 'bg-white dark:bg-dark-surface border-gray-200 dark:border-gray-600 text-gray-500'"
                                    x-text="getContactInitials(c.id)" :title="c.name"></button>
                             </template>
                        </div>
                    </div>
                    <div>
                         <label class="label-xs">Temps (H)</label>
                         <div class="grid grid-cols-2 gap-2">
                             <input type="number" x-model="tempTask.timeEst" placeholder="Est." class="input-std bg-white dark:bg-dark-surface text-center">
                             <input type="number" x-model="tempTask.timeSpent" placeholder="Réel" class="input-std bg-white dark:bg-dark-surface text-center">
                         </div>
                    </div>
                    
                    <div class="pt-4 border-t border-gray-200 dark:border-gray-700 space-y-2">
                        <label class="label-xs">Champs Personnalisés</label>
                        
                        <template x-for="(field, index) in tempTask._customFieldsArray" :key="index">
                            <div class="flex space-x-2 items-center">
                                <input type="text" x-model="field.key" placeholder="Clé" class="input-std flex-1 p-1.5 text-xs bg-white dark:bg-dark-surface">
                                <input type="text" x-model="field.value" placeholder="Valeur" class="input-std flex-1 p-1.5 text-xs bg-white dark:bg-dark-surface">
                                <button @click="tempTask._customFieldsArray.splice(index, 1)" type="button" class="w-6 h-6 flex items-center justify-center text-red-500 hover:text-red-700 transition">
                                    <i class="fa-solid fa-xmark text-sm"></i>
                                </button>
                            </div>
                        </template>
                        
                        <button @click="tempTask._customFieldsArray.push({ key: '', value: '' })" type="button" class="w-full py-1 text-primary-500 hover:text-primary-700 transition text-xs font-medium flex items-center justify-center gap-1">
                            <i class="fa-solid fa-plus"></i> Ajouter un champ
                        </button>
                    </div>
                    
                </div>
            </div>
            <div class="modal-footer justify-between sticky bottom-0 shadow-lg">
                <div class="flex gap-2">
                    <button x-show="tempTask.id && tempTask.participants && tempTask.participants.length > 0"
                            @click="generateTaskAssignmentICS(tempTask)"
                            type="button"
                            class="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition flex items-center gap-2"
                            title="Télécharger fichier ICS de la tâche">
                        <i class="fa-solid fa-calendar-check"></i> Exporter ICS
                    </button>
                    <button x-show="tempTask.id && tempTask.participants && tempTask.participants.length > 0"
                            @click="emailTaskAssignmentICS(tempTask)"
                            type="button"
                            class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm transition flex items-center gap-2"
                            title="Envoyer la tâche par email aux participants">
                        <i class="fa-solid fa-paper-plane"></i> Envoyer aux participants
                    </button>
                </div>
                <div class="flex gap-3">
                    <button @click="modals.task = false" class="px-6 py-3 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition font-semibold text-base border-2 border-gray-300 dark:border-gray-600 flex items-center gap-2">
                        <i class="fa-solid fa-times"></i> Fermer
                    </button>
                    <button @click="saveTask()" class="px-8 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow-lg transition font-bold text-base flex items-center gap-2 animate-pulse hover:animate-none">
                        <i class="fa-solid fa-check"></i> Enregistrer
                    </button>
                </div>
            </div>
        </div>
        
        <div x-show="modals.contact" @click.away="modals.contact = false" class="bg-white dark:bg-dark-surface w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden">
             <div class="px-8 py-5 border-b border-gray-100 dark:border-gray-700 font-bold text-xl dark:text-white">Fiche Contact</div>
             <div class="p-8 space-y-5">
                 <input type="text" x-model="tempContact.name" placeholder="Nom Complet" class="input-std">
                 <input type="email" x-model="tempContact.email" placeholder="Email" class="input-std">
                 <input type="text" x-model="tempContact.org" placeholder="Organisation" class="input-std">
                 <input type="text" x-model="tempContact.phone" placeholder="Téléphone" class="input-std">
             </div>
             <div class="modal-footer">
                <button x-show="tempContact.id" @click="deleteContact(tempContact.id)" class="mr-auto text-red-500 text-sm hover:underline">Supprimer</button>
                <button @click="modals.contact = false" class="btn-secondary">Annuler</button>
                <button @click="saveContact()" class="btn-primary">Sauvegarder</button>
            </div>
        </div>

        <div x-show="modals.meeting" @click.away="modals.meeting = false" class="bg-white dark:bg-dark-surface w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden">
             <div class="bg-purple-600 px-8 py-5 text-white font-bold text-xl flex items-center gap-2"><i class="fa-solid fa-calendar-days"></i> Planifier Réunion</div>
             <div class="p-8 space-y-5">
                <p class="text-sm text-gray-600 dark:text-gray-300">Pour: <strong x-text="tempMeeting.title"></strong></p>
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" x-model="tempMeeting.date" class="input-std">
                    <input type="time" x-model="tempMeeting.time" class="input-std">
                </div>
                <input type="text" x-model="tempMeeting.location" placeholder="Lieu / Lien Teams" class="input-std">

                <div x-show="tempMeeting.participants && tempMeeting.participants.length > 0" class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                    <p class="text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-2">Participants invités</p>
                    <div class="flex flex-wrap gap-2">
                        <template x-for="p in tempMeeting.participants" :key="p.email">
                            <span class="bg-white dark:bg-dark-surface px-2 py-1 rounded text-xs border border-gray-200 dark:border-gray-600 flex items-center gap-1">
                                <i class="fa-solid fa-user text-gray-400"></i>
                                <span x-text="p.name"></span>
                            </span>
                        </template>
                    </div>
                </div>

                <button @click="generateICS()" class="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-bold shadow-lg shadow-purple-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-download"></i> Télécharger Invitation .ICS
                </button>
                <button x-show="tempMeeting.participants && tempMeeting.participants.length > 0"
                        @click="emailMeetingInvitation()"
                        class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg shadow-blue-500/30 transition transform active:scale-95 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-paper-plane"></i> Envoyer par Email aux Participants
                </button>
             </div>
        </div>

    </div>

    <script>
        function app() {
            return {
                isDark: false,
                currentView: 'dashboard',
                searchQuery: '',
                filterProject: null,
                filterRoadmapProject: null,

                projects: [],
                tasks: [],
                contacts: [],
                toasts: [],
                
                // Config
                kanbanColumns: ['À faire', 'En cours', 'En attente', 'Terminé'],
                eisenhowerQuadrants: [
                    { u: true, i: true, title: 'Faire (Urgent & Important)', bgClass: 'bg-red-50 dark:bg-red-900/10', headerClass: 'text-red-700 dark:text-red-400', borderClass: 'border-l-red-500', icon: '<i class="fa-solid fa-fire"></i>' },
                    { u: false, i: true, title: 'Planifier (Important)', bgClass: 'bg-blue-50 dark:bg-blue-900/10', headerClass: 'text-blue-700 dark:text-blue-400', borderClass: 'border-l-blue-500', icon: '<i class="fa-solid fa-calendar"></i>' },
                    { u: true, i: false, title: 'Déléguer (Urgent)', bgClass: 'bg-amber-50 dark:bg-amber-900/10', headerClass: 'text-amber-700 dark:text-amber-400', borderClass: 'border-l-amber-500', icon: '<i class="fa-solid fa-user-clock"></i>' },
                    { u: false, i: false, title: 'Éliminer', bgClass: 'bg-gray-100 dark:bg-gray-800/30', headerClass: 'text-gray-600 dark:text-gray-400', borderClass: 'border-l-gray-400', icon: '<i class="fa-solid fa-trash-can"></i>' }
                ],
                menuItems: [
                    { id: 'dashboard', label: 'Cockpit', icon: 'fa-solid fa-chart-pie' },
                    { id: 'roadmap', label: 'Roadmap', icon: 'fa-solid fa-route' },
                    { id: 'projects', label: 'Projets', icon: 'fa-solid fa-folder-open' },
                    { id: 'kanban', label: 'Kanban', icon: 'fa-solid fa-table-columns' },
                    { id: 'eisenhower', label: 'Matrice Eisenhower', icon: 'fa-solid fa-border-all' },
                    { id: 'contacts', label: 'Contacts', icon: 'fa-solid fa-address-book' }
                ],
                
                // Modals
                modals: { project: false, task: false, contact: false, meeting: false },
                // task includes: notes (string), customFields (object), _customFieldsArray (temp array for UI)
                tempProject: {}, tempTask: { participants: [], notes: '', customFields: {}, _customFieldsArray: [] }, tempContact: {}, tempMeeting: {},

                initApp() {
                    // Theme Init
                    if (localStorage.getItem('pf_theme') === 'dark' || (!('pf_theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                        this.isDark = true;
                        document.documentElement.classList.add('dark');
                    }
                    this.load();
                    if(this.projects.length === 0) this.seed();
                },

                toggleTheme() {
                    this.isDark = !this.isDark;
                    if(this.isDark) document.documentElement.classList.add('dark');
                    else document.documentElement.classList.remove('dark');
                    localStorage.setItem('pf_theme', this.isDark ? 'dark' : 'light');
                },
                
                // Notifications
                showToast(title, message, type = 'success') {
                    const id = Date.now();
                    this.toasts.push({ id, title, message, type });
                    setTimeout(() => { this.toasts = this.toasts.filter(t => t.id !== id); }, 3000);
                },

                // CRUD
                save() {
                    localStorage.setItem('pf_data', JSON.stringify({
                        projects: this.projects, tasks: this.tasks, contacts: this.contacts
                    }));
                },
                load() {
                    const d = JSON.parse(localStorage.getItem('pf_data') || '{}');
                    this.projects = d.projects || [];
                    this.tasks = d.tasks || [];
                    this.contacts = d.contacts || [];

                    // Migration / Normalisation des anciennes tâches pour les nouveaux champs
                    this.tasks.forEach((t, idx) => {
                        if (t.customFields === undefined) t.customFields = {};
                        if (t.notes === undefined) t.notes = '';
                        if (t.order === undefined) t.order = idx;
                    });

                    // Initialiser l'ordre pour les projets et contacts si nécessaire
                    this.projects.forEach((p, idx) => {
                        if (p.order === undefined) p.order = idx;
                    });

                    this.contacts.forEach((c, idx) => {
                        if (c.order === undefined) c.order = idx;
                    });
                },
                seed() {
                    const pid = 'p1';
                    this.projects = [{ id: pid, name: "ProjectFlow Launch", role: "Leader", status: "Actif", color: "#3b82f6", endDate: "2024-12-31", description: "Lancement de la super app." }];
                    this.tasks = [
                        { id: 't1', projectId: pid, title: "Design UI", status: "Terminé", urgent: true, important: true, participants: [], notes: "UI/UX finalisé. Prêt pour le développement.", customFields: { "Réf client": "ACME-2024", "Budget alloué": "5000" } },
                        { id: 't2', projectId: pid, title: "Code Logic", status: "En cours", urgent: false, important: true, participants: [], dueDate: "2024-11-30", notes: "Commencer l'intégration Alpine/Tailwind. Penser à la réactivité Kanban.", customFields: {} }
                    ];
                    this.save();
                },
                
                // Helpers
                generateId: () => Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                getProjectName(id) { return (this.projects.find(p => p.id === id) || {}).name || '---'; },
                getContactName(id) { return (this.contacts.find(c => c.id === id) || {}).name || '?'; },
                getContactInitials(id) { 
                    const n = this.getContactName(id); 
                    return n === '?' ? '?' : n.split(' ').map(x=>x[0]).join('').substring(0,2).toUpperCase(); 
                },
                formatDate(d) { return d ? new Date(d).toLocaleDateString('fr-FR') : ''; },
                formatDateShort(d) { return d ? new Date(d).toLocaleDateString('fr-FR', {day:'numeric', month:'numeric'}) : ''; },
                getRemainingDays(d) { if(!d) return '-'; const diff = new Date(d) - new Date(); return Math.ceil(diff / (1000 * 60 * 60 * 24)); },
                isOverdue(d) { return d && new Date(d) < new Date().setHours(0,0,0,0); },

                // Filters & Computed
                get filteredProjects() {
                    let projects = this.projects;
                    if(this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        projects = projects.filter(p => p.name.toLowerCase().includes(q));
                    }
                    // Tri par ordre (si défini)
                    return projects.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999999;
                        const orderB = b.order !== undefined ? b.order : 999999;
                        return orderA - orderB;
                    });
                },
                get filteredContacts() {
                    let contacts = this.contacts;
                    if(this.searchQuery) {
                        const q = this.searchQuery.toLowerCase();
                        contacts = contacts.filter(c => c.name.toLowerCase().includes(q) || (c.org && c.org.toLowerCase().includes(q)));
                    }
                    // Tri par ordre (si défini)
                    return contacts.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999999;
                        const orderB = b.order !== undefined ? b.order : 999999;
                        return orderA - orderB;
                    });
                },

                // Logic specific
                getProjectProgress(pid) {
                    const t = this.tasks.filter(x => x.projectId === pid);
                    if(!t.length) return 0;
                    return Math.round((t.filter(x => x.status === 'Terminé').length / t.length) * 100);
                },
                calculateGlobalProgress() {
                    if(!this.tasks.length) return 0;
                    return Math.round((this.tasks.filter(t => t.status === 'Terminé').length / this.tasks.length) * 100);
                },
                
                // Task Management
                openTaskModal(defaults = {}) {
                    // Initialiser la tâche par défaut ou cloner l'existante
                    const baseTask = {
                        id: null, title: '', description: '', status: 'À faire', urgent: false, important: false,
                        projectId: this.filterProject||'', participants: [], notes: '', customFields: {},
                        timeEst: '', timeSpent: '', dueDate: '', checklist: [],
                        ...defaults
                    };

                    if(defaults.id) {
                        this.tempTask = JSON.parse(JSON.stringify(defaults)); // Clone
                    } else {
                        this.tempTask = baseTask;
                    }

                    // CONVERSION POUR L'UI: Object {key:value} -> Array [{key, value}]
                    this.tempTask._customFieldsArray = Object.entries(this.tempTask.customFields || {}).map(([key, value]) => ({ key, value }));

                    if(!this.tempTask.participants) this.tempTask.participants = [];
                    if(!this.tempTask.checklist) this.tempTask.checklist = [];
                    this.modals.task = true;
                },
                toggleParticipant(cid) {
                    if(this.tempTask.participants.includes(cid)) 
                        this.tempTask.participants = this.tempTask.participants.filter(id => id !== cid);
                    else this.tempTask.participants.push(cid);
                },
                saveTask() {
                    if(!this.tempTask.title) return;
                    
                    // CONVERSION POUR LA SAUVEGARDE: Array [{key, value}] -> Object {key:value}
                    const customFieldsObj = {};
                    this.tempTask._customFieldsArray.forEach(f => {
                        if (f.key && f.key.trim()) {
                            customFieldsObj[f.key.trim()] = f.value || '';
                        }
                    });
                    this.tempTask.customFields = customFieldsObj;
                    
                    // Cloner l'objet sans le champ temporaire de l'UI
                    const taskToSave = JSON.parse(JSON.stringify(this.tempTask));
                    delete taskToSave._customFieldsArray; 
                    
                    if(this.tempTask.id) {
                        const idx = this.tasks.findIndex(t => t.id === this.tempTask.id);
                        this.tasks[idx] = taskToSave;
                    } else {
                        taskToSave.id = this.generateId();
                        this.tasks.push(taskToSave);
                    }
                    this.save();
                    this.modals.task = false;
                    this.showToast('Succès', 'Tâche enregistrée');
                },
                deleteTask(id) {
                    if(confirm('Supprimer ?')) {
                        this.tasks = this.tasks.filter(t => t.id !== id);
                        this.save();
                        this.modals.task = false;
                        this.showToast('Info', 'Tâche supprimée', 'info');
                    }
                },
                getTasksByStatus(s) {
                    const filtered = this.tasks.filter(t => t.status === s && (!this.filterProject || t.projectId === this.filterProject) && t.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                    // Tri par ordre (si défini), sinon par défaut
                    return filtered.sort((a, b) => {
                        const orderA = a.order !== undefined ? a.order : 999999;
                        const orderB = b.order !== undefined ? b.order : 999999;
                        return orderA - orderB;
                    });
                },
                getMatrixTasks(u, i) {
                    return this.tasks.filter(t => t.status !== 'Terminé' && t.urgent === u && t.important === i && (!this.filterProject || t.projectId === this.filterProject));
                },

                // Meeting Notes Actions
                copyNotes(notes) {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(notes).then(() => {
                            this.showToast('Copié', 'Notes copiées dans le presse-papier');
                        }).catch(() => {
                            this.showToast('Erreur', 'Impossible de copier', 'error');
                        });
                    } else {
                        alert('Le presse-papier n\'est pas supporté par ce navigateur.');
                    }
                },
                emailNotes(notes, title) {
                    const subject = encodeURIComponent(`Notes de la tâche : ${title}`);
                    const body = encodeURIComponent(notes);
                    // Utilise mailto: pour déclencher le client mail par défaut (Outlook)
                    window.location.href = `mailto:?subject=${subject}&body=${body}`;
                },

                // Project Management
                openProjectModal(p = null) {
                    this.tempProject = p ? JSON.parse(JSON.stringify(p)) : { id: null, name: '', role: 'Leader', status: 'Actif', color: '#3b82f6' };
                    this.modals.project = true;
                },
                saveProject() {
                    if(!this.tempProject.name) return;
                    if(this.tempProject.id) {
                        const idx = this.projects.findIndex(x => x.id === this.tempProject.id);
                        this.projects[idx] = this.tempProject;
                    } else {
                        this.tempProject.id = this.generateId();
                        this.projects.push(this.tempProject);
                    }
                    this.save();
                    this.modals.project = false;
                    this.showToast('Succès', 'Projet mis à jour');
                },
                deleteProject(id) {
                    if(confirm('Supprimer projet et tâches associées ?')) {
                        this.projects = this.projects.filter(p => p.id !== id);
                        this.tasks = this.tasks.filter(t => t.projectId !== id);
                        this.save();
                        this.showToast('Supprimé', 'Projet archivé', 'info');
                    }
                },

                // Contact Management
                openContactModal(c = null) {
                    this.tempContact = c ? JSON.parse(JSON.stringify(c)) : { id: null, name: '', email: '', org: '', phone: '' };
                    this.modals.contact = true;
                },
                saveContact() {
                    if(!this.tempContact.name) return;
                    if(this.tempContact.id) {
                        const idx = this.contacts.findIndex(c => c.id === this.tempContact.id);
                        this.contacts[idx] = this.tempContact;
                    } else {
                        this.tempContact.id = this.generateId();
                        this.contacts.push(this.tempContact);
                    }
                    this.save();
                    this.modals.contact = false;
                    this.showToast('Succès', 'Contact enregistré');
                },
                deleteContact(id) {
                    if(confirm('Supprimer ?')) {
                        this.contacts = this.contacts.filter(c => c.id !== id);
                        this.save();
                        this.modals.contact = false;
                    }
                },

                // Gantt Visuals (Kept simple for demo, position based on a mock calculation)
                getGanttStyle(t, pColor) {
                    const daysLeft = this.getRemainingDays(t.dueDate);
                    const widthCalc = Math.max(10, Math.min(100, daysLeft * 5));
                    return `width: ${widthCalc}%; background-color: ${pColor}; opacity: 0.8;`;
                },

                // UI Helpers
                getAddButtonLabel() {
                    if(this.currentView === 'contacts') return 'Contact';
                    if(this.currentView === 'projects') return 'Projet';
                    return 'Tâche';
                },
                openModalForView() {
                    if(this.currentView === 'contacts') this.openContactModal();
                    else if(this.currentView === 'projects') this.openProjectModal();
                    else this.openTaskModal();
                },

                // Sortable - Kanban avec réorganisation dans les colonnes
                initSortable(el) {
                    new Sortable(el, {
                        group: 'kanban',
                        animation: 200,
                        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                        ghostClass: 'ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        delay: 100,
                        delayOnTouchOnly: true,
                        forceFallback: false,
                        fallbackTolerance: 3,
                        handle: null, // Tout l'élément est draggable
                        onStart: (evt) => {
                            evt.item.style.cursor = 'grabbing';
                        },
                        onEnd: (evt) => {
                            evt.item.style.cursor = 'grab';
                            const id = evt.item.dataset.id;
                            const status = evt.to.dataset.status;
                            const newIndex = evt.newIndex;

                            const task = this.tasks.find(x => x.id === id);
                            if (!task) return;

                            // Mettre à jour le statut si changement de colonne
                            if (task.status !== status) {
                                task.status = status;
                                this.showToast('Tâche déplacée', `"${task.title}" → ${status}`, 'info');
                            }

                            // Réorganiser l'ordre des tâches selon la nouvelle position
                            const tasksInColumn = this.tasks.filter(t => t.status === status);
                            const taskIndex = tasksInColumn.findIndex(t => t.id === id);

                            if (taskIndex !== -1) {
                                // Retirer la tâche de sa position actuelle
                                tasksInColumn.splice(taskIndex, 1);
                                // L'insérer à la nouvelle position
                                tasksInColumn.splice(newIndex, 0, task);

                                // Mettre à jour les ordres
                                tasksInColumn.forEach((t, idx) => {
                                    t.order = idx;
                                });
                            }

                            this.save();
                        }
                    });
                },
                initMatrixSortable(el) {
                    new Sortable(el, {
                        group: 'matrix',
                        animation: 200,
                        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                        ghostClass: 'ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        delay: 100,
                        delayOnTouchOnly: true,
                        onStart: (evt) => {
                            evt.item.style.cursor = 'grabbing';
                        },
                        onEnd: (evt) => {
                            evt.item.style.cursor = 'grab';
                            const id = evt.item.dataset.id;
                            const u = evt.to.dataset.u === 'true';
                            const i = evt.to.dataset.i === 'true';
                            const t = this.tasks.find(x => x.id === id);

                            if(t) {
                                const oldUrgent = t.urgent;
                                const oldImportant = t.important;
                                t.urgent = u;
                                t.important = i;

                                // Notification si changement
                                if (oldUrgent !== u || oldImportant !== i) {
                                    const quadrantNames = {
                                        'true_true': 'Faire (Urgent & Important)',
                                        'false_true': 'Planifier (Important)',
                                        'true_false': 'Déléguer (Urgent)',
                                        'false_false': 'Éliminer'
                                    };
                                    const newQuadrant = quadrantNames[`${u}_${i}`];
                                    this.showToast('Tâche déplacée', `"${t.title}" → ${newQuadrant}`, 'info');
                                }

                                this.save();
                                this.tasks = [...this.tasks];
                            }
                        }
                    });
                },

                // Sortable - Projets
                initProjectsSortable(el) {
                    new Sortable(el, {
                        animation: 200,
                        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                        ghostClass: 'ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        delay: 100,
                        delayOnTouchOnly: true,
                        filter: '.btn, button, a, input, textarea, select',
                        preventOnFilter: true,
                        onStart: (evt) => {
                            evt.item.style.cursor = 'grabbing';
                        },
                        onEnd: (evt) => {
                            evt.item.style.cursor = 'grab';
                            const id = evt.item.dataset.id;
                            const newIndex = evt.newIndex;

                            const project = this.projects.find(p => p.id === id);
                            if (!project) return;

                            // Réorganiser l'ordre des projets
                            const projectIndex = this.projects.findIndex(p => p.id === id);
                            if (projectIndex !== -1) {
                                // Retirer le projet de sa position actuelle
                                this.projects.splice(projectIndex, 1);
                                // L'insérer à la nouvelle position
                                this.projects.splice(newIndex, 0, project);

                                // Mettre à jour les ordres
                                this.projects.forEach((p, idx) => {
                                    p.order = idx;
                                });

                                this.save();
                                this.showToast('Projet déplacé', `"${project.name}" réorganisé`, 'success');
                            }
                        }
                    });
                },

                // Sortable - Contacts
                initContactsSortable(el) {
                    new Sortable(el, {
                        animation: 200,
                        easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
                        ghostClass: 'ghost',
                        chosenClass: 'sortable-chosen',
                        dragClass: 'sortable-drag',
                        delay: 100,
                        delayOnTouchOnly: true,
                        filter: '.btn, button, a, input, textarea, select',
                        preventOnFilter: true,
                        onStart: (evt) => {
                            evt.item.style.cursor = 'grabbing';
                        },
                        onEnd: (evt) => {
                            evt.item.style.cursor = 'grab';
                            const id = evt.item.dataset.id;
                            const newIndex = evt.newIndex;

                            const contact = this.contacts.find(c => c.id === id);
                            if (!contact) return;

                            // Réorganiser l'ordre des contacts
                            const contactIndex = this.contacts.findIndex(c => c.id === id);
                            if (contactIndex !== -1) {
                                // Retirer le contact de sa position actuelle
                                this.contacts.splice(contactIndex, 1);
                                // L'insérer à la nouvelle position
                                this.contacts.splice(newIndex, 0, contact);

                                // Mettre à jour les ordres
                                this.contacts.forEach((c, idx) => {
                                    c.order = idx;
                                });

                                this.save();
                                this.showToast('Contact déplacé', `"${contact.name}" réorganisé`, 'success');
                            }
                        }
                    });
                },

                // Exports
                exportData() {
                    const b = new Blob([localStorage.getItem('pf_data')], {type: 'application/json'});
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(b);
                    a.download = `ProjectFlow_Backup_${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                },
                importData(e) {
                    const r = new FileReader();
                    r.onload = (ev) => {
                        localStorage.setItem('pf_data', ev.target.result);
                        window.location.reload();
                    };
                    r.readAsText(e.target.files[0]);
                },
                exportExcel() {
                    const wb = XLSX.utils.book_new();
                    // Sheet 1: Projets
                    const projectData = this.projects.map(p => ({
                        Nom: p.name,
                        Rôle: p.role,
                        Statut: p.status,
                        "Date Fin": p.endDate,
                        Progression: this.getProjectProgress(p.id)+'%',
                        Description: p.description
                    }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(projectData), "Projets");

                    // Sheet 2: Tâches
                    const taskData = this.tasks.map(t => ({
                        Titre: t.title,
                        Projet: this.getProjectName(t.projectId),
                        Statut: t.status,
                        Urgent: t.urgent ? 'Oui' : 'Non',
                        Important: t.important ? 'Oui' : 'Non',
                        Échéance: t.dueDate,
                        "Temps Est.": t.timeEst || '',
                        "Temps Réel": t.timeSpent || '',
                        "Notes Réunion": t.notes || '',
                        // C'est ici que les champs custom sont intégrés à l'export Excel
                        ...t.customFields 
                    }));
                    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(taskData), "Tâches");

                    XLSX.writeFile(wb, "ProjectFlow_Report.xlsx");
                },
                openMeetingModal(t) {
                    // Initialise la modale de réunion avec les infos de la tâche
                    this.tempMeeting = { 
                        title: t.title, 
                        date: new Date().toISOString().slice(0,10), // Date d'aujourd'hui par défaut
                        time: '10:00', // Heure par défaut
                        duration: 60, 
                        location: 'Teams', // Lieu par défaut
                        participants: t.participants.map(id => this.contacts.find(c => c.id === id) || {name: 'Inconnu', email: ''})
                    };
                    this.modals.meeting = true;
                },
                generateICS() {
                    // Date & Heure
                    const date = this.tempMeeting.date.replace(/-/g,'');
                    const time = this.tempMeeting.time.replace(':','') + '00';
                    const start = `${date}T${time}`;

                    // Calcul de l'heure de fin (simplifié à 1h par défaut)
                    const [h, m] = this.tempMeeting.time.split(':').map(Number);
                    const endDate = new Date(this.tempMeeting.date);
                    endDate.setHours(h + 1, m, 0); // Ajoute 1 heure
                    const end = endDate.toISOString().replace(/[-:]/g,'').substring(0, 15);

                    // Créer les lignes ATTENDEE pour les participants
                    const attendees = this.tempMeeting.participants
                        .filter(p => p.email)
                        .map(p => `ATTENDEE;CN=${p.name};RSVP=TRUE:mailto:${p.email}`)
                        .join('\n');

                    // Corps du fichier ICS
                    const icsLines = [
                        'BEGIN:VCALENDAR',
                        'VERSION:2.0',
                        'PRODID:-//ProjectFlow//FR',
                        'METHOD:REQUEST',
                        'BEGIN:VEVENT',
                        `UID:${this.generateId()}`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').substring(0, 15)}Z`,
                        `DTSTART:${start}`,
                        `DTEND:${end}`,
                        `SUMMARY:${this.tempMeeting.title}`,
                        `LOCATION:${this.tempMeeting.location}`,
                        `STATUS:CONFIRMED`
                    ];

                    if (attendees) {
                        icsLines.push(attendees);
                    }

                    icsLines.push('END:VEVENT');
                    icsLines.push('END:VCALENDAR');

                    const ics = icsLines.join('\n');

                    // Téléchargement
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([ics], {type: 'text/calendar'}));
                    a.download = `${this.tempMeeting.title.replace(/\s/g,'_')}_invitation.ics`;
                    a.click();

                    this.modals.meeting = false;
                    this.showToast('ICS Généré', 'Le fichier d\'invitation de calendrier a été téléchargé avec ' + this.tempMeeting.participants.length + ' participant(s)');
                },

                // Génère un fichier ICS avec le contenu VTODO pour une tâche assignée
                generateTaskAssignmentICS(task) {
                    if (!task || !task.title) return;

                    // Formatage de la date d'échéance
                    const dueDate = task.dueDate ? task.dueDate.replace(/-/g,'') : '';

                    // Déterminer la priorité (1=haute, 5=moyenne, 9=basse)
                    let priority = 5;
                    if (task.urgent && task.important) priority = 1;
                    else if (task.urgent || task.important) priority = 3;
                    else priority = 7;

                    // Statut de la tâche en format ICS
                    const statusMap = {
                        'À faire': 'NEEDS-ACTION',
                        'En cours': 'IN-PROCESS',
                        'En attente': 'IN-PROCESS',
                        'Terminé': 'COMPLETED'
                    };
                    const icsStatus = statusMap[task.status] || 'NEEDS-ACTION';

                    // Description détaillée
                    let description = task.description || '';
                    if (task.notes) {
                        description += (description ? '\\n\\n' : '') + 'Notes: ' + task.notes;
                    }

                    // Créer les lignes ATTENDEE pour les participants
                    const attendees = (task.participants || [])
                        .map(cid => this.contacts.find(c => c.id === cid))
                        .filter(c => c && c.email)
                        .map(c => `ATTENDEE;CN=${c.name};ROLE=REQ-PARTICIPANT;PARTSTAT=NEEDS-ACTION:mailto:${c.email}`)
                        .join('\n');

                    // Corps du fichier ICS en format VTODO
                    const icsLines = [
                        'BEGIN:VCALENDAR',
                        'VERSION:2.0',
                        'PRODID:-//ProjectFlow//FR',
                        'METHOD:REQUEST',
                        'BEGIN:VTODO',
                        `UID:task-${task.id}@projectflow`,
                        `DTSTAMP:${new Date().toISOString().replace(/[-:]/g,'').substring(0, 15)}Z`,
                        `SUMMARY:${task.title}`,
                        `STATUS:${icsStatus}`,
                        `PRIORITY:${priority}`
                    ];

                    if (dueDate) {
                        icsLines.push(`DUE:${dueDate}`);
                    }

                    if (description) {
                        icsLines.push(`DESCRIPTION:${description.replace(/\n/g, '\\n')}`);
                    }

                    if (task.projectId) {
                        const projectName = this.getProjectName(task.projectId);
                        icsLines.push(`CATEGORIES:${projectName}`);
                    }

                    if (attendees) {
                        icsLines.push(attendees);
                    }

                    icsLines.push('END:VTODO');
                    icsLines.push('END:VCALENDAR');

                    const ics = icsLines.join('\n');

                    // Téléchargement
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(new Blob([ics], {type: 'text/calendar'}));
                    a.download = `Tache_${task.title.replace(/\s/g,'_')}.ics`;
                    a.click();

                    this.showToast('ICS Généré', 'Fichier de tâche ICS téléchargé');
                },

                // Envoie une tâche par email avec fichier ICS en pièce jointe (via mailto)
                emailTaskAssignmentICS(task) {
                    if (!task || !task.title) return;

                    // Récupérer les emails des participants
                    const participantEmails = (task.participants || [])
                        .map(cid => this.contacts.find(c => c.id === cid))
                        .filter(c => c && c.email)
                        .map(c => c.email);

                    if (participantEmails.length === 0) {
                        this.showToast('Erreur', 'Aucun participant avec email trouvé', 'error');
                        return;
                    }

                    // Construire le corps du message
                    let emailBody = `Vous avez été assigné(e) à la tâche suivante :\n\n`;
                    emailBody += `Titre : ${task.title}\n`;
                    if (task.description) emailBody += `Description : ${task.description}\n`;
                    if (task.dueDate) emailBody += `Échéance : ${this.formatDate(task.dueDate)}\n`;
                    if (task.projectId) emailBody += `Projet : ${this.getProjectName(task.projectId)}\n`;
                    emailBody += `Priorité : ${task.urgent ? 'URGENT ' : ''}${task.important ? 'IMPORTANT' : ''}\n`;
                    if (task.notes) emailBody += `\nNotes :\n${task.notes}\n`;
                    emailBody += `\n\nMerci de consulter le fichier ICS ci-joint pour ajouter cette tâche à votre calendrier.`;

                    // Note: mailto ne supporte pas les pièces jointes directement
                    // On inclut donc les informations dans le corps du message
                    const subject = encodeURIComponent(`[ProjectFlow] Tâche assignée : ${task.title}`);
                    const body = encodeURIComponent(emailBody);
                    const to = participantEmails.join(',');

                    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;

                    // Également générer le fichier ICS pour téléchargement
                    this.generateTaskAssignmentICS(task);

                    this.showToast('Email préparé', 'Votre client email va s\'ouvrir. Le fichier ICS a été téléchargé.');
                },

                // Envoie l'invitation de réunion par email aux participants
                emailMeetingInvitation() {
                    const participantEmails = this.tempMeeting.participants
                        .filter(p => p.email)
                        .map(p => p.email);

                    if (participantEmails.length === 0) {
                        this.showToast('Erreur', 'Aucun participant avec email trouvé', 'error');
                        return;
                    }

                    // Construire le corps du message
                    let emailBody = `Vous êtes invité(e) à la réunion suivante :\n\n`;
                    emailBody += `Sujet : ${this.tempMeeting.title}\n`;
                    emailBody += `Date : ${this.formatDate(this.tempMeeting.date)}\n`;
                    emailBody += `Heure : ${this.tempMeeting.time}\n`;
                    emailBody += `Lieu : ${this.tempMeeting.location}\n`;
                    emailBody += `\nVeuillez consulter le fichier ICS ci-joint pour ajouter cette réunion à votre calendrier.\n`;
                    emailBody += `\nÀ bientôt !`;

                    const subject = encodeURIComponent(`[ProjectFlow] Invitation : ${this.tempMeeting.title}`);
                    const body = encodeURIComponent(emailBody);
                    const to = participantEmails.join(',');

                    window.location.href = `mailto:${to}?subject=${subject}&body=${body}`;

                    // Également générer le fichier ICS
                    this.generateICS();

                    this.showToast('Email préparé', 'Votre client email va s\'ouvrir avec l\'invitation.');
                }
            }
        }
    </script>
    
    <style>
        .input-std { @apply w-full border border-gray-300 dark:border-gray-600 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-primary-500/50 outline-none dark:bg-dark-bg dark:text-white transition; }
        .label-xs { @apply text-xs font-bold text-gray-500 dark:text-gray-400 uppercase mb-1 block; }
        .btn-primary { @apply px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white rounded-lg shadow-sm transition; }
        .btn-secondary { @apply px-4 py-2 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition; }
        .modal-footer { @apply px-8 py-5 bg-gray-50 dark:bg-gray-800/50 border-t border-gray-100 dark:border-gray-700 flex justify-end gap-3 mt-auto; }
    </style>
</body>
</html>
